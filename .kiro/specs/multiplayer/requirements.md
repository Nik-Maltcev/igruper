# Мультиплеер — Superigruper

## Обзор
Мультиплеерная сессия, привязанная к реальному календарю. Игроки соревнуются друг с другом в комнате на протяжении всей игры (все эпохи). Каждая неделя реального времени = один игровой год. Смена фаз происходит автоматически в 22:00.

---

## US-1: Регистрация и идентификация игрока
Как игрок, я хочу ввести никнейм при первом заходе, чтобы меня узнавали в комнате.

### Acceptance Criteria
- AC-1.1: При первом заходе на сайт отображается экран ввода никнейма
- AC-1.2: Никнейм сохраняется в localStorage и используется при последующих заходах
- AC-1.3: Игрок может изменить никнейм из настроек
- AC-1.4: Никнейм уникален в пределах комнаты (нельзя два одинаковых)

---

## US-2: Создание и вход в комнату
Как игрок, я хочу создать комнату или войти по коду, чтобы играть с друзьями.

### Acceptance Criteria
- AC-2.1: Кнопка "Создать комнату" генерирует 4-значный буквенно-цифровой код
- AC-2.2: Создатель комнаты становится хостом
- AC-2.3: Комната вмещает от 3 до 8 игроков
- AC-2.4: Другие игроки входят по 4-значному коду
- AC-2.5: Нельзя войти в комнату, если она уже заполнена или игра началась

---

## US-3: Лобби
Как хост, я хочу видеть всех подключившихся игроков и запустить игру, когда все готовы.

### Acceptance Criteria
- AC-3.1: В лобби отображается список всех игроков с никнеймами
- AC-3.2: Код комнаты виден всем для приглашения друзей
- AC-3.3: Хост видит кнопку "Начать игру" (активна при 3+ игроках)
- AC-3.4: Игра начинается только в пятницу (хост может нажать "Начать" — игра стартует в ближайшую пятницу в 00:00, или сразу если сейчас пятница до 22:00)
- AC-3.5: При старте каждый игрок получает 3 стартовые машины и 15000 денежных единиц

---

## US-4: Недельный цикл игры
Как игрок, я хочу чтобы игра шла по недельному расписанию, привязанному к реальному календарю.

### Acceptance Criteria
- AC-4.1: Каждая реальная неделя = один игровой год (эпоха)
- AC-4.2: Смена фаз происходит автоматически в 22:00 каждого дня
- AC-4.3: Расписание недели:
  - **Пятница (старт)**: Квалификация — тюнинг стартовых машин до 22:00. После 22:00 гаражи становятся видимыми, расстановка машин на квалификационные трассы
  - **Суббота**: Квалификация — расстановка машин до 22:00. В 22:00 гонки квалификации + открытие автосалона (машины текущего года)
  - **Воскресенье**: Покупка машин в автосалоне до 22:00. В 22:00 автосалон закрывается, смена на фазу тюнинга
  - **Понедельник**: Тюнинг — покупка и установка деталей до 22:00
  - **Вторник**: Городские Состязания — расстановка машин до 22:00, в 22:00 гонки
  - **Среда**: Тюнинг — покупка и установка деталей до 22:00
  - **Четверг**: Национальное Соревнование — расстановка машин до 22:00, в 22:00 гонки + переход к пятнице (тюнинг перед Мировой Серией)
  - **Пятница**: Тюнинг до 22:00
  - **Суббота**: Мировая Серия — расстановка машин до 22:00, в 22:00 гонки
  - **Воскресенье**: Смена игрового года, открытие автосалона нового года
- AC-4.4: Квалификация проводится только один раз — при старте игры. Далее цикл: Пн-Вт-Ср-Чт-Пт-Сб-Вс
- AC-4.5: После 22:00 покупки/тюнинг заблокированы до следующей фазы тюнинга

---

## US-5: Видимость информации между игроками
Как игрок, я хочу чтобы мои покупки и расстановка были скрыты до определённого момента.

### Acceptance Criteria
- AC-5.1: Во время фазы тюнинга/покупок — гараж игрока виден только ему
- AC-5.2: После 22:00 (смена фазы) — гаражи всех игроков становятся видимыми во вкладке ИГРОКИ
- AC-5.3: Расстановка машин на трассы скрыта до 22:00 дня гонки
- AC-5.4: После 22:00 дня гонки — расстановка видна всем во вкладке ЗАЕЗДЫ
- AC-5.5: Результаты гонок видны всем сразу после подсчёта

---

## US-6: Городские Состязания (вторник)
Как игрок, я хочу участвовать в городских гонках, чтобы заработать деньги и очки.

### Acceptance Criteria
- AC-6.1: Автомобили с пометкой АВТОСПОРТ не допускаются
- AC-6.2: У каждой трассы своё требование (класс, тип дороги и т.д.)
- AC-6.3: На каждую трассу выставляется одна машина от игрока
- AC-6.4: Денежный приз присуждается за каждый отдельный заезд
- AC-6.5: Баллы начисляются за общее положение по всем городским гонкам

---

## US-7: Национальное Соревнование (четверг)
Как игрок, я хочу участвовать в национальных гонках с более серьёзной конкуренцией.

### Acceptance Criteria
- AC-7.1: Единое требование устанавливается сразу на три трассы
- AC-7.2: На каждую трассу выставляется одна машина от игрока
- AC-7.3: Машины с меткой АВТОСПОРТ допускаются
- AC-7.4: Денежный приз и баллы — за общее положение по всем трём гонкам Национального Соревнования

---

## US-8: Мировая Серия (суббота)
Как игрок, я хочу участвовать в главном событии недели с максимальными призами.

### Acceptance Criteria
- AC-8.1: Состоит из обычной гонки, бонусного заезда за призом и главной гонки
- AC-8.2: Главная гонка проводится отдельно для каждой категории мощности:
  - 0–120 лс
  - 121–200 лс
  - 201–300 лс
  - 301–450 лс
  - 451–650 лс
  - 651–900 лс
  - 900+ лс
- AC-8.3: На главную гонку можно отправить несколько машин из разных категорий мощности
- AC-8.4: Теоретически можно отправить до 7 машин и получить 7 призов

---

## US-9: Механика гонок
Как игрок, я хочу видеть честное соревнование между машинами всех игроков.

### Acceptance Criteria
- AC-9.1: Машины всех игроков, выставленные на одну гонку, соревнуются друг с другом
- AC-9.2: Результат рассчитывается по формуле из gameEngine (веса трассы × характеристики машины с учётом деталей и коэффициентов)
- AC-9.3: Если на гонку выставился только один игрок — автоматическая победа
- AC-9.4: Места распределяются между реальными игроками
- AC-9.5: Начисляются очки и призовые деньги по местам

---

## US-10: Анимация гонки
Как игрок, я хочу посмотреть визуализацию гонки.

### Acceptance Criteria
- AC-10.1: После подсчёта результатов появляется кнопка "ПОСМОТРЕТЬ ГОНКУ"
- AC-10.2: Машинки с именами игроков схематично двигаются по 2D трассе (вид сверху)
- AC-10.3: Отставания между машинами соответствуют расчёту по формуле
- AC-10.4: В конце анимации показывается таблица результатов

---

## US-11: Рейтинг и результаты
Как игрок, я хочу видеть общий рейтинг и результаты всех гонок.

### Acceptance Criteria
- AC-11.1: После каждого гоночного дня отображается таблица результатов дня
- AC-11.2: Общий рейтинг игроков (сумма очков за все гонки) виден всегда
- AC-11.3: Побеждает игрок с наибольшим количеством очков в конце игры

---

## US-12: Автосалон в мультиплеере
Как игрок, я хочу покупать новые машины при смене игрового года.

### Acceptance Criteria
- AC-12.1: Автосалон открывается после гонок субботы (квалификация) или после Мировой Серии
- AC-12.2: Доступны машины текущего игрового года (эпохи)
- AC-12.3: Автосалон закрывается в 22:00 воскресенья
- AC-12.4: Количество машин в наличии общее для всей комнаты (если кто-то купил — наличие уменьшается для всех)

---

## US-13: Чат комнаты
Как игрок, я хочу общаться с другими игроками в комнате через текстовый чат.

### Acceptance Criteria
- AC-13.1: Чат доступен на всех экранах внутри комнаты (сворачиваемая панель)
- AC-13.2: Сообщения синхронизируются через Supabase Realtime
- AC-13.3: Отображается никнейм отправителя и время сообщения
- AC-13.4: История чата сохраняется на время жизни комнаты
- AC-13.5: Системные сообщения: вход/выход игрока, смена фазы, результаты гонок

---

## US-14: Аукцион деталей
Как игрок, я хочу продавать и покупать детали у других игроков через аукцион.

### Acceptance Criteria
- AC-14.1: Игрок может выставить деталь из своего гаража на аукцион с начальной ценой
- AC-14.2: Другие игроки видят лоты и могут делать ставки
- AC-14.3: Аукцион работает во время фазы тюнинга
- AC-14.4: Лот закрывается при смене фазы — деталь уходит победителю ставки
- AC-14.5: Если ставок не было — деталь возвращается владельцу
- AC-14.6: Реализация аукциона будет продумана позже (placeholder в UI)

---

## Технические требования

### Supabase таблицы
- `rooms` — id, code, status, host_id, current_day, current_year, phase, day_started_at, created_at, max_players (3-8)
- `room_players` — id, room_id, player_id, username, is_host, money, garage (JSONB), points, joined_at
- `race_entries` — id, room_id, player_id, race_id, car_id, day
- `race_results` — id, room_id, race_id, player_id, car_name, position, earnings, points, day
- `chat_messages` — id, room_id, player_id, username, message, type (user/system), created_at
- `auction_lots` — id, room_id, seller_id, part_data (JSONB), car_id, min_price, current_bid, bidder_id, status, created_at (позже)

### Supabase Realtime
- Подписка на изменения `rooms` (смена фазы, дня, года)
- Подписка на `room_players` (новые игроки, обновление очков)
- Подписка на `race_results` (результаты гонок)
- Подписка на `chat_messages` (новые сообщения)
- Подписка на `auction_lots` (новые лоты, ставки) — позже

### Ограничения первой версии
- Нет реконнекта (вышел = потерял прогресс)
- Нет зрителей
- Максимум 8 игроков в комнате
- Аукцион — placeholder, реализация позже
