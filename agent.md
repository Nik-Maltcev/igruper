# Street King Manager — Agent Context

## Что это

Браузерный симулятор управления гоночной командой. Игрок покупает машины (классика 60-х и современные), ставит запчасти разных тиров и брендов, участвует в гонках против ботов или реальных игроков через мультиплеер.

## Стек

- React 19 + TypeScript (Vite, SPA)
- Tailwind CSS (через CDN `cdn.tailwindcss.com`)
- Lucide React — иконки
- Supabase — мультиплеер (realtime, rooms, room_players)
- Шрифт: Exo 2
- Нет роутера, навигация через `useState<View>`

## Структура файлов

```
App.tsx              — корневой компонент, глобальный стейт (money, myCars, gamePhase, day)
index.tsx            — точка входа React
index.html           — HTML + importmap + Tailwind CDN
types.ts             — все типы (Car, Part, Track, Room, RoomPlayer, etc.)
constants.ts         — данные: машины (AVAILABLE_CARS), запчасти (SHOP_PARTS), трассы (TRACKS), боты (MOCK_OPPONENTS)
services/
  gameEngine.ts      — simulateRace() — расчёт гонки по формуле (speed/handling/offroad × веса трассы × погода × рандом)
  supabase.ts        — клиент Supabase + isSupabaseConfigured()
components/
  Dashboard.tsx      — главное меню (сетка кнопок навигации)
  Garage.tsx         — просмотр своих машин и установленных деталей
  Marketplace.tsx    — покупка машин (автосалон) и запчастей (тюнинг), фильтр по бренду
  RaceCenter.tsx     — одиночные гонки против ботов (выбор трассы, погода, анимация, результаты)
  Multiplayer.tsx    — онлайн PvP через Supabase (создание/вход в комнату, лобби, гонка, результаты)
```

## Игровая механика

### Экономика
- Стартовый капитал: $15,000
- Машины: от $3,700 (Spark) до $50,000 (Ferrari FXX-K, Ford Shelby Baja)
- Запчасти: 3 тира (Tier 1/2/3), ~10 брендов (Trash Shopito, Магазин Запчастей, Девяточка, ABC, Батыр, Sumimoto, Breyton, DymDymych, Volga+, Topcar, Mugen, Hennesy, AMG, Dunlop, Brabus, RalliArt)
- Призовые: 1 место = $5,000, 2 = $2,500, 3 = $1,000

### Характеристики машин
- `speed` — скорость
- `handling` — управляемость
- `offroad` — проходимость
- Запчасти дают `boost` к одному из трёх статов

### Гоночный движок (`simulateRace`)
- Формула: `averageSpeed = speed×w_speed + handling×w_handling + offroad×w_offroad`
- Погода (SUNNY/RAIN/STORM) снижает скорость, handling/offroad смягчают штраф
- Рандом: ±5 км/ч
- Дистанция: 4 км → время = дистанция / скорость
- Аргумент `includeBots` — для мультиплеера ботов отключают

### Трассы
- Ночной Драг (speed 0.9, handling 0.1)
- Тоге Дрифт (speed 0.3, handling 0.7)
- Грунтовое Ралли (speed 0.4, handling 0.2, offroad 0.4)

### Фазы игры
- `PREPARATION` — покупка/тюнинг (днём)
- `RACE_DAY` — гонки (в 22:00, переключается кнопкой отладки)

## Мультиплеер (Supabase)

### Таблицы
- `rooms` — id, code, status (WAITING/RACING/FINISHED), host_id, track_id
- `room_players` — id, room_id, username, is_host, car_data (jsonb), finish_time, position

### Флоу
1. Логин (никнейм) → Создать/Войти в комнату по коду
2. Лобби: до 8 игроков, хост видит кнопку старта
3. Хост запускает гонку → simulateRace на стороне хоста → результаты пишутся в БД
4. Realtime подписка обновляет UI у всех
5. Хост может сбросить лобби для следующей гонки

## Текущее состояние и известные проблемы

### Работает
- Навигация по экранам
- Покупка машин и запчастей
- Одиночные гонки с ботами
- Мультиплеер (базовый флоу)
- Анимация гонки (прогресс-бар)

### Заглушки / не реализовано
- `AUCTION` — экран-заглушка ("в разработке")
- `PLAYERS` — экран-заглушка
- `RULES` — экран-заглушка
- `HISTORY` — View есть в типах, но нигде не используется
- Выбор машины для установки запчасти (сейчас всегда первая)
- Выбор машины для гонки (сейчас все машины участвуют)
- Продажа машин / запчастей
- Сохранение прогресса (localStorage / Supabase)
- Выбор трассы в мультиплеере (захардкожена первая)
- Класс машины (отображается "Класс C", но не рассчитывается)
- StatBar в Garage ограничен 100 (а реальные значения speed доходят до 354)

### Архитектурные заметки
- Весь стейт в App.tsx через useState — нет контекста, нет стейт-менеджера
- Запчасти устанавливаются навсегда, нет снятия/замены
- Supabase URL и ключ захардкожены в `services/supabase.ts`
- Tailwind через CDN (не через PostCSS/конфиг) — нет кастомных утилит
- `index.html` содержит importmap (ESM), но Vite тоже настроен — потенциальный конфликт

## Язык

Весь UI на русском. Комментарии в коде — смесь русского и английского. Общение с пользователем — на русском.
